<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Payslip | RSR HRMS</title>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <style>
    :root {
      --rsr-blue: #0052cc;
      --rsr-text: #222222;
      --rsr-text-light: #717171;
      --rsr-border: #ebebeb;
      --rsr-bg: #f7f9fc;
      --rsr-white: #ffffff;
    }

    body {
      background-color: var(--rsr-bg);
      font-family: 'Plus Jakarta Sans', sans-serif;
      color: var(--rsr-text);
      letter-spacing: -0.01em;
    }

    /* Navbar styling to match suite */
    .navbar {
      background: var(--rsr-white) !important;
      border-bottom: 1px solid var(--rsr-border);
      padding: 1rem 0;
    }

    .navbar-brand {
      font-weight: 800;
      color: var(--rsr-blue) !important;
    }

    .container-wrapper {
      background: var(--rsr-white);
      border-radius: 24px;
      padding: 40px;
      margin: 40px auto;
      border: 1px solid var(--rsr-border);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
    }

    .page-header {
      border-bottom: 1px solid var(--rsr-border);
      padding-bottom: 25px;
      margin-bottom: 35px;
    }

    /* LOP Summary Section */
    .lop-summary {
      background: #f8fafc;
      border: 1px solid var(--rsr-border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 35px;
    }

    .lop-badge {
      font-size: 0.85rem;
      padding: 10px 18px;
      border-radius: 12px;
      font-weight: 700;
      margin-right: 10px;
    }

    /* Form Section */
    .form-section {
      background: var(--rsr-white);
      border: 1px solid var(--rsr-border);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 40px;
    }

    .form-label {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--rsr-text-light);
      margin-bottom: 8px;
    }

    .form-control {
      border-radius: 10px;
      border: 1px solid var(--rsr-border);
      padding: 12px;
      font-size: 0.95rem;
    }

    .btn-generate {
      background-color: var(--rsr-blue);
      border: none;
      padding: 14px 40px;
      font-weight: 700;
      border-radius: 12px;
      color: white;
      transition: all 0.2s ease;
    }

    .btn-generate:hover {
      background-color: #0043a8;
      transform: translateY(-1px);
    }

    /* Table Section */
    .table-wrapper {
      background: var(--rsr-white);
      border: 1px solid var(--rsr-border);
      border-radius: 16px;
      overflow: hidden;
    }

    .table thead {
      background-color: #f8fafc;
    }

    .table thead th {
      border: none;
      padding: 15px 20px;
      font-weight: 700;
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--rsr-text-light);
    }

    .table tbody td {
      padding: 15px 20px;
      vertical-align: middle;
      font-size: 0.9rem;
      border-bottom: 1px solid var(--rsr-border);
    }

    .calculation-note {
      background: #fff9db;
      border: 1px solid #fcf0b6;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 25px;
      font-size: 0.85rem;
    }

    .btn-download {
      background: #f1f5f9;
      color: var(--rsr-blue);
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.8rem;
    }
  </style>
</head>

<body>
  <%- include('../partials/anti-cache') %>

    <nav class="navbar navbar-expand-lg sticky-top">
      <div class="container">
        <a class="navbar-brand" href="/hr/dashboard">
          <i class="bi bi-wallet2 me-2"></i> RSR HRMS
        </a>
        <div class="ms-auto">
          <a href="/payslip/hr/payslips" class="btn btn-outline-dark btn-sm rounded-pill px-4">Back to Payroll</a>
        </div>
      </div>
    </nav>

    <div class="container container-wrapper">
      <div class="page-header">
        <p class="text-primary fw-bold small mb-1" style="letter-spacing: 0.1em;">FINANCIAL RECORDS</p>
        <h2 class="fw-bold"><i class="bi bi-file-earmark-person"></i>
          <%= employee.firstName %>
            <%= employee.lastName %>
        </h2>
      </div>

      <div class="lop-summary d-flex align-items-center justify-content-between">
        <div>
          <h6 class="fw-bold mb-2">Leave Without Pay (LOP) Summary</h6>
          <span class="badge lop-badge bg-danger bg-opacity-10 text-danger">
            Total LOP (All Time): <%= totalLopDays %> Days
          </span>
          <span class="badge lop-badge bg-warning bg-opacity-10 text-dark">
            This Month LOP: <%= monthlyLopDays %> Days
          </span>
        </div>
        <i class="bi bi-calendar-check fs-1 text-light"></i>
      </div>

      <div class="form-section">
        <h5 class="fw-bold mb-4">Generate Monthly Statement</h5>
        <form action="/payslip/generate" method="POST">
          <input type="hidden" name="employeeId" value="<%= employee._id %>" />

          <div class="row g-3 mb-4">
            <div class="col-md-3">
              <label class="form-label">Salary Month</label>
              <select name="month" class="form-select" required>
                <% const months=["January", "February" , "March" , "April" , "May" , "June" , "July" , "August"
                  , "September" , "October" , "November" , "December" ]; %>
                  <% months.forEach((m, i)=> { %>
                    <option value="<%= i + 1 %>" <%=new Date().getMonth()===i ? 'selected' : '' %>><%= m %>
                    </option>
                    <% }) %>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Financial Year</label>
              <input type="number" name="year" class="form-control" value="<%= new Date().getFullYear() %>" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Basic Salary (Monthly)</label>
              <div class="input-group">
                <span class="input-group-text bg-white">₹</span>
                <input type="number" name="basicSalary" class="form-control" placeholder="0.00"
                  value="<%= employee.salary || '' %>" required />
              </div>
            </div>
          </div>

          <!-- EARNINGS SECTION -->
          <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">Earnings Breakdown</h6>
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <label class="form-label">House Rent Allowance (HRA)</label>
              <input type="number" name="hra" class="form-control" value="<%= employee.hra || 0 %>" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Travel Allowance</label>
              <input type="number" name="travelAllowance" class="form-control"
                value="<%= employee.travelAllowance || 0 %>" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Other Allowances</label>
              <input type="number" name="otherAllowances" class="form-control"
                value="<%= employee.otherAllowances || 0 %>" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Performance Bonus</label>
              <input type="number" name="bonuses" class="form-control" value="0" />
            </div>
          </div>

          <!-- DEDUCTIONS SECTION -->
          <h6 class="text-danger fw-bold mb-3 border-bottom pb-2">Deductions Breakdown</h6>
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <label class="form-label">Provident Fund (PF)</label>
              <input type="number" name="pf" class="form-control" value="<%= employee.pf || 0 %>" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Professional Tax</label>
              <input type="number" name="professionalTax" class="form-control"
                value="<%= employee.professionalTax || 0 %>" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Income Tax (TDS)</label>
              <input type="number" name="taxes" class="form-control" value="0" />
            </div>
            <div class="col-md-12">
              <label class="form-label">Other Manual Deductions</label>
              <input type="number" name="deductions" class="form-control" value="0" />
            </div>
          </div>

          <div class="text-center">
            <button type="submit" class="btn btn-generate shadow-sm">
              <i class="bi bi-file-earmark-check me-2"></i> Commit & Generate Payslip
            </button>
          </div>
        </form>
      </div>

      <div class="table-section">
        <h5 class="fw-bold mb-3">Previous Salary Disks</h5>

        <div class="calculation-note">
          <i class="bi bi-calculator-fill me-2"></i>
          <strong>Net Pay Calculation Logic:</strong> [Basic + Allowances + Bonuses] minus [Automatic LOP + Manual
          Deductions + Taxes]
        </div>



        <div class="table-wrapper">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Period</th>
                  <th>Basic</th>
                  <th>LOP Days</th>
                  <th>Deductions</th>
                  <th>Deduction Details</th>
                  <th>Bonuses</th>
                  <th>Net Pay</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (payslips && payslips.length> 0) { %>
                  <% payslips.forEach(function(payslip) { %>
                    <tr>
                      <td><span class="fw-bold">
                          <%= payslip.month %>/<%= payslip.year %>
                        </span></td>
                      <td>₹<%= payslip.basicSalary.toLocaleString('en-IN') %>
                      </td>
                      <td>
                        <span
                          class="badge rounded-pill <%= payslip.lopDays > 0 ? 'bg-danger bg-opacity-10 text-danger' : 'bg-success bg-opacity-10 text-success' %>">
                          <%= payslip.lopDays %> Days
                        </span>
                      </td>
                      <td class="text-danger fw-bold">₹<%= payslip.deductions.toLocaleString('en-IN') %>
                      </td>
                      <td>
                        <% if (payslip.deductionDetails && payslip.deductionDetails.length> 0) { %>
                          <div class="small text-muted">
                            <% payslip.deductionDetails.forEach(function(d) { %>
                              <div>
                                <%= d.label %>: ₹<%= d.amount.toFixed(0) %>
                              </div>
                              <% }) %>
                          </div>
                          <% } else { %> - <% } %>
                      </td>
                      <td class="text-success">₹<%= payslip.bonuses.toLocaleString('en-IN') %>
                      </td>
                      <td class="fw-bold text-primary">₹<%= payslip.netPay.toLocaleString('en-IN') %>
                      </td>
                      <td>
                        <span
                          class="badge <%= payslip.paymentStatus === 'Paid' ? 'bg-success' : 'bg-warning text-dark' %>">
                          <%= payslip.paymentStatus %>
                        </span>
                      </td>
                      <td>
                        <a href="/payslip/download/<%= payslip._id %>" class="btn btn-download btn-sm">
                          <i class="bi bi-download"></i>
                        </a>
                      </td>
                    </tr>
                    <% }); %>
                      <% } else { %>
                        <tr>
                          <td colspan="9" class="text-center py-5 text-muted">No historical salary data found.</td>
                        </tr>
                        <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center py-5">
      <p class="text-muted small">© 2026 RSR HRMS • Financial Compliance Audit Terminal</p>
    </footer>

</body>

</html>