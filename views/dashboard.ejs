<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Dashboard | RSR HRMS</title>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --rsr-blue: #0052cc;
      --rsr-bg: #ffffff;
      --rsr-light: #f7f9fc;
      --text-main: #222222;
      --text-muted: #717171;
      --border-color: #ebebeb;
    }

    body {
      background-color: var(--rsr-bg);
      font-family: 'Plus Jakarta Sans', sans-serif;
      color: var(--text-main);
      letter-spacing: -0.01em;
    }

    /* Navbar */
    .navbar {
      background: #fff !important;
      border-bottom: 1px solid var(--border-color);
      padding: 1.2rem 0;
    }

    .navbar-brand {
      font-weight: 800;
      color: var(--rsr-blue) !important;
      letter-spacing: -0.03em;
    }

    /* Welcome Header */
    .welcome-header {
      padding: 60px 0 40px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 40px;
    }

    .welcome-header h1 {
      font-weight: 800;
      font-size: 2.5rem;
      margin-bottom: 8px;
    }

    /* Card Styling */
    .card {
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      background: #fff;
    }

    .card:hover {
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    }

    .card-header {
      background: transparent;
      border-bottom: 1px solid var(--border-color);
      padding: 20px 24px;
      font-weight: 700;
      font-size: 1.1rem;
    }

    /* Performance Grid */
    .metric-card {
      padding: 24px;
      text-align: center;
      border-right: 1px solid var(--border-color);
    }

    .metric-card:last-child {
      border-right: none;
    }

    .metric-value {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--rsr-blue);
    }

    .metric-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Action Links (The Sidebar/List Style) */
    .action-item {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      text-decoration: none;
      color: var(--text-main);
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .action-item:hover {
      background: var(--rsr-light);
      border-color: var(--rsr-blue);
    }

    .action-item i {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--rsr-light);
      color: var(--rsr-blue);
      border-radius: 10px;
      margin-right: 15px;
    }

    /* Buttons */
    .btn-primary {
      background-color: var(--rsr-blue);
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      font-weight: 600;
    }

    /* Alerts */
    .birthday-alert {
      background: linear-gradient(90deg, #fdfcfb 0%, #e2d1c3 100%);
      border: none;
      border-radius: 12px;
      padding: 20px;
      color: #8a6d3b;
    }
  </style>
</head>

<body>

  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
      <a class="navbar-brand" href="/dashboard">
        <i class="fa-solid fa-paper-plane me-2"></i> RSR AVIATION
      </a>
      <div class="ms-auto d-flex align-items-center text-dark">
        <i class="fa-solid fa-user me-2"></i>
        <span class="me-3 fw-medium d-none d-md-inline">
          <%= employee.firstName %>
        </span>
        <a href="/logout" class="btn btn-outline-dark btn-sm rounded-pill px-3">Log out</a>
      </div>
    </div>
  </nav>

  <header class="welcome-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <p class="text-primary fw-bold mb-1" style="letter-spacing: 0.1em;">DASHBOARD</p>
          <h1>Welcome <%= employee.firstName %>
          </h1>
          <p class="text-muted fs-5">RSR Human Resource Management Operations</p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <a href="/employee/profile" class="btn btn-outline-primary shadow-sm"><i
              class="fa-solid fa-user-gear me-2"></i> My Profile</a>
        </div>
      </div>
    </div>
  </header>

  <div class="container">

    <% if (typeof passwordUpdated !=='undefined' && passwordUpdated) { %>
      <div class="alert alert-success border-0 shadow-sm d-flex align-items-center mb-4">
        <span class="fs-4 me-3">‚úÖ</span>
        <div>
          <h5 class="mb-0 fw-bold">Success!</h5>
          <p class="mb-0">Your password has been updated securely.</p>
        </div>
      </div>
      <% } %>

        <% let showBirthdayAlert=false; if (employee && employee.dob) { const today=new Date(); const dob=new
          Date(employee.dob); showBirthdayAlert=(today.getDate()===dob.getDate() && today.getMonth()===dob.getMonth());
          } %>
          <% if (showBirthdayAlert) { %>
            <div class="alert birthday-alert shadow-sm d-flex align-items-center mb-4">
              <span class="fs-2 me-3">üéÇ</span>
              <div>
                <h5 class="mb-0 fw-bold">Happy Birthday, <%= employee.firstName %>!</h5>
                <p class="mb-0">Wishing you a great flight today!</p>
              </div>
            </div>
            <% } %>

              <% let othersBirthdays=[]; if (typeof employees !=='undefined' && employee) { const today=new Date();
                const todayDay=today.getDate(); const todayMonth=today.getMonth();
                othersBirthdays=employees.filter(emp=> {
                if (!emp.dob || emp._id.toString() === employee._id.toString()) return false;
                const dob = new Date(emp.dob);
                return dob.getDate() === todayDay && dob.getMonth() === todayMonth;
                });
                }
                %>
                <% if (othersBirthdays.length> 0) { %>
                  <div class="alert alert-info border-0 shadow-sm d-flex align-items-center mb-4">
                    <span class="fs-4 me-3">üéâ</span>
                    <div>
                      Today is <strong>
                        <%= othersBirthdays.map(emp=> emp.firstName + ' ' + emp.lastName).join(', ') %>
                      </strong> birthday! Let's wish them!
                    </div>
                  </div>
                  <% } %>

                    <% /* Today's Announcements Logic */ let todayAnnouncements=[]; if (typeof announcements
                      !=='undefined' && announcements.length> 0) {
                      const today = new Date();
                      todayAnnouncements = announcements.filter(a => {
                      const aDate = new Date(a.date);
                      return aDate.getDate() === today.getDate() &&
                      aDate.getMonth() === today.getMonth() &&
                      aDate.getFullYear() === today.getFullYear();
                      });
                      }
                      %>

                      <% if (todayAnnouncements.length> 0) { %>
                        <div class="alert alert-warning border-0 shadow-sm d-flex align-items-center mb-4"
                          style="background-color: #fff3cd; color: #856404;">
                          <span class="fs-4 me-3">üì¢</span>
                          <div>
                            <h5 class="mb-1 fw-bold">New Announcement</h5>
                            <% todayAnnouncements.forEach(a=> { %>
                              <div><strong>
                                  <%= a.title %>:
                                </strong>
                                <%= a.message %>
                              </div>
                              <% }) %>
                          </div>
                        </div>
                        <% } %>

                          <% /* Today's Notifications Logic */ let todayNotifications=[]; if (typeof notifications
                            !=='undefined' && notifications.length> 0) {
                            const today = new Date();
                            todayNotifications = notifications.filter(n => {
                            const nDate = new Date(n.date);
                            return nDate.getDate() === today.getDate() &&
                            nDate.getMonth() === today.getMonth() &&
                            nDate.getFullYear() === today.getFullYear();
                            });
                            }
                            %>

                            <% if (todayNotifications.length> 0) { %>
                              <div class="alert alert-primary border-0 shadow-sm d-flex align-items-center mb-4"
                                style="background-color: #cff4fc; color: #055160;">
                                <span class="fs-4 me-3">‚ÑπÔ∏è</span>
                                <div>
                                  <h5 class="mb-1 fw-bold">Daily Notification</h5>
                                  <% todayNotifications.forEach(n=> { %>
                                    <div><strong>
                                        <%= n.title %>:
                                      </strong>
                                      <%= n.message %>
                                    </div>
                                    <% }) %>
                                </div>
                              </div>
                              <% } %>

                                <div class="row g-4 mb-5">

                                  <div class="col-lg-7">
                                    <div class="card h-100">
                                      <div class="card-header"><i class="fa-solid fa-clock me-2"></i> Today's Attendance
                                      </div>
                                      <div class="card-body p-4">
                                        <div class="d-flex align-items-center justify-content-between">
                                          <div>
                                            <% if (!attendance) { %>
                                              <h4 class="text-danger fw-bold mb-1">Status: Not Marked</h4>
                                              <p class="text-muted mb-0">No record for today.</p>
                                              <% } else if (attendance && !attendance.punchOut) { %>
                                                <h4 class="text-warning fw-bold mb-1">Status: In Progress</h4>
                                                <p class="text-muted mb-0">Punch In: <%=
                                                    attendance.punchIn.toLocaleTimeString() %>
                                                </p>
                                                <% } else { %>
                                                  <h4 class="text-success fw-bold mb-1">Status: Completed</h4>
                                                  <p class="text-muted mb-0">In: <%=
                                                      attendance.punchIn.toLocaleTimeString() %> | Out:
                                                      <%= attendance.punchOut.toLocaleTimeString() %>
                                                  </p>
                                                  <% } %>
                                          </div>
                                          <a href="/attendance" class="btn btn-primary px-4 shadow-sm">Mark
                                            Attendance</a>
                                        </div>
                                        <hr class="my-4">
                                        <a href="/regularization" class="text-decoration-none text-muted small"><i
                                            class="fa-solid fa-pen-to-square me-1"></i> Attendance Regularization</a>
                                      </div>
                                    </div>
                                  </div>

                                  <div class="col-lg-5">
                                    <div class="card h-100">
                                      <div class="card-header"><i class="fa-solid fa-plane-circle-xmark me-2"></i> Leave
                                        Management
                                      </div>
                                      <div class="card-body p-4 text-center">
                                        <div class="mb-3">
                                          <span class="display-5 fw-bold text-primary">
                                            <%= employee.leaveBalance %>
                                          </span>
                                          <span class="text-muted fs-4">/ 25</span>
                                        </div>
                                        <p class="text-muted mb-4">Leaves Left</p>
                                        <div class="d-grid gap-2">
                                          <a href="/leave/apply" class="btn btn-primary">Apply Leave</a>
                                          <a href="/leave/my-leaves" class="btn btn-outline-primary border">My
                                            Leaves</a>
                                        </div>
                                      </div>
                                    </div>
                                  </div>

                                  <div class="col-12">
                                    <div class="card">
                                      <div class="card-body p-0">
                                        <div class="row g-0">
                                          <div class="col-md-4 metric-card">
                                            <div class="metric-value">
                                              <%= workingDays %>
                                            </div>
                                            <div class="metric-label">Working Days</div>
                                          </div>
                                          <div class="col-md-4 metric-card">
                                            <div class="metric-value text-success">
                                              <%= daysPresent %>
                                            </div>
                                            <div class="metric-label">Days Present</div>
                                          </div>
                                          <div class="col-md-4 metric-card">
                                            <div class="metric-value text-danger">
                                              <%= leavesTaken %>
                                            </div>
                                            <div class="metric-label">Leaves Taken</div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>

                                  <div class="col-md-6">
                                    <h5 class="fw-bold mb-3">Field Operations</h5>
                                    <button onclick="performCheckIn()"
                                      class="action-item w-100 text-start border-0 shadow-sm mb-3 bg-white">
                                      <div class="d-flex align-items-center">
                                        <i class="fa-solid fa-location-crosshairs text-primary"></i>
                                        <div class="ms-3">
                                          <strong>Instant Check-In</strong><br>
                                          <small class="text-muted" id="checkin-status">Log current location</small>
                                        </div>
                                      </div>
                                    </button>

                                    <h5 class="fw-bold mb-3">Resources</h5>
                                    <a href="/expense/my-expenses" class="action-item">
                                      <i class="fa-solid fa-wallet"></i>
                                      <span><strong>My Expenses</strong><br><small class="text-muted">Claims &
                                          Reimbursements</small></span>
                                    </a>
                                    <a href="/trip/my-trips" class="action-item">
                                      <i class="fa-solid fa-plane-departure"></i>
                                      <span><strong>My Trips</strong><br><small class="text-muted">Travel Requests &
                                          History</small></span>
                                    </a>
                                    <a href="/documents" class="action-item">
                                      <i class="fa-solid fa-file-invoice"></i>
                                      <span><strong>My Documents</strong><br><small class="text-muted">ID Cards &
                                          Certs</small></span>
                                    </a>
                                    <a href="/notice-board" class="action-item">
                                      <i class="fa-solid fa-bullhorn"></i>
                                      <span><strong>Notice Board</strong><br><small
                                          class="text-muted">Announcements</small></span>
                                    </a>
                                  </div>

                                  <div class="col-md-6">
                                    <h5 class="fw-bold mb-3">Operations</h5>
                                    <% if (employee) { %>
                                      <a href="/payslip/employee/<%= employee._id %>" class="action-item">
                                        <i class="fa-solid fa-money-bill-wave"></i>
                                        <span><strong>Payslips</strong><br><small class="text-muted">Download Payroll
                                            Statements</small></span>
                                      </a>
                                      <a href="/department/<%= employee.department %>/training/<%= employee._id %>"
                                        class="action-item">
                                        <i class="fa-solid fa-graduation-cap"></i>
                                        <span><strong>Training</strong><br><small class="text-muted">My
                                            Progress</small></span>
                                      </a>

                                      <% if (employee.designation !=='MANAGER' ) { %>
                                        <a href="/department/<%= employee.department %>/mytasks/<%= employee._id %>"
                                          class="action-item">
                                          <i class="fa-solid fa-tasks"></i>
                                          <span><strong>My Tasks</strong><br><small class="text-muted">Current
                                              Assignments</small></span>
                                        </a>
                                        <% } %>
                                          <% } %>
                                            <a href="/department/<%= employee.department %>" class="action-item">
                                              <i class="fa-solid fa-users"></i>
                                              <span><strong>Department Dashboard</strong><br><small
                                                  class="text-muted">Team
                                                  View</small></span>
                                            </a>
                                            <a href="/auth/change-password" class="action-item">
                                              <i class="fa-solid fa-key"></i>
                                              <span><strong>Change Password</strong><br><small class="text-muted">Update
                                                  Security</small></span>
                                            </a>
                                  </div>

                                  <% if (employee && (employee.designation==='MANAGER' ||
                                    employee.designation==='Manager' )) { %>
                                    <div class="col-12 mt-4">
                                      <div class="p-5 bg-light rounded-4 border">
                                        <h3 class="fw-bold mb-4"><i class="fa-solid fa-shield-halved me-2"></i> Manager
                                          Control Center
                                        </h3>
                                        <div class="row g-3">
                                          <div class="col-md-3">
                                            <a href="/department/<%= employee.department %>/announcement"
                                              class="btn btn-white border w-100 py-3 shadow-sm">Post Notice</a>
                                          </div>
                                          <div class="col-md-3">
                                            <a href="/department/<%= employee.department %>/task"
                                              class="btn btn-white border w-100 py-3 shadow-sm">Assign Tasks</a>
                                          </div>
                                          <div class="col-md-3">
                                            <a href="/department/<%= employee.department %>/leave"
                                              class="btn btn-white border w-100 py-3 shadow-sm">Approve Leaves</a>
                                          </div>
                                          <div class="col-md-3">
                                            <a href="/department/<%= employee.department %>"
                                              class="btn btn-white border w-100 py-3 shadow-sm text-primary">Department
                                              Hub</a>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                    <% } %>

                                </div>
  </div>

  <footer class="text-center py-5 mt-5 border-top">
    <p class="text-muted small">¬© 2026 RSR Aviation Group ‚Ä¢ Human Resource Management</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function performCheckIn() {
      const statusText = document.getElementById('checkin-status');

      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser");
        return;
      }

      statusText.innerHTML = '<span class="text-primary"><i class="fa-solid fa-spinner fa-spin"></i> Acquiring GPS...</span>';

      navigator.geolocation.getCurrentPosition(async (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        try {
          statusText.innerHTML = "Sending update...";
          const res = await fetch('/expense/check-in', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lat, lng })
          });

          const data = await res.json();
          if (data.success) {
            statusText.innerHTML = '<span class="text-success fw-bold"><i class="fa-solid fa-check"></i> Checked In!</span>';
            setTimeout(() => statusText.innerHTML = "Log current location", 3000);
          } else {
            statusText.innerHTML = "Failed. Try again.";
          }
        } catch (err) {
          console.error(err);
          statusText.innerHTML = "Network Error";
        }

      }, (err) => {
        console.warn(err);
        statusText.innerHTML = '<span class="text-danger">Permission Denied</span>';
        alert("Please allow location access to check in.");
      });
    }
  </script>
</body>

</html>