<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Update Location | RSR HRMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <style>
        body {
            background-color: #f7f9fc;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .map-container {
            flex: 1;
            width: 100%;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        .controls-overlay {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-light bg-white border-bottom px-3 py-3">
        <a href="/dashboard" class="btn btn-outline-dark rounded-circle me-3"><i class="fa-solid fa-arrow-left"></i></a>
        <span class="navbar-brand mb-0 h1 fw-bold">Update My Location</span>
    </nav>

    <div class="map-container">
        <div id="map"></div>

        <div class="controls-overlay">
            <h6 class="fw-bold mb-3"><i class="fa-solid fa-location-dot text-danger me-2"></i> Set Current Status</h6>

            <div class="mb-3">
                <select id="statusSelect" class="form-select border-primary">
                    <option value="On Duty">üü¢ On Duty - Field Visit</option>
                    <option value="Traveling">‚úàÔ∏è Traveling</option>
                    <option value="Client Meeting">ü§ù Client Meeting</option>
                    <option value="Remote Work">üè† Remote Work</option>
                </select>
            </div>

            <div class="d-flex gap-2 align-items-center mb-3">
                <div class="text-muted small flex-grow-1" id="coord-display">
                    <i class="fa-solid fa-spinner fa-spin"></i> Locating...
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="locateMe()">
                    <i class="fa-solid fa-crosshairs"></i> Recenter
                </button>
            </div>

            <button class="btn btn-primary w-100 py-2 fw-bold shadow-sm" onclick="submitUpdate()">
                <i class="fa-solid fa-paper-plane me-2"></i> Update Location
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        const map = L.map('map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

        let marker;
        let currentPos = { lat: null, lng: null };

        function setPin(lat, lng) {
            currentPos = { lat, lng };
            if (marker) {
                marker.setLatLng([lat, lng]);
            } else {
                marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                marker.on('dragend', function (e) {
                    const p = e.target.getLatLng();
                    currentPos = { lat: p.lat, lng: p.lng };
                    updateDisplay();
                });
            }
            map.setView([lat, lng], 15);
            updateDisplay();
        }

        function updateDisplay() {
            document.getElementById('coord-display').innerHTML =
                `Lat: <b>${currentPos.lat.toFixed(4)}</b>, Lng: <b>${currentPos.lng.toFixed(4)}</b>`;
        }

        function locateMe() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    setPin(p.coords.latitude, p.coords.longitude);
                }, err => {
                    alert("GPS unavailable. Drag map manually.");
                    if (!currentPos.lat) setPin(28.6139, 77.2090); // Fallback
                });
            } else {
                alert("Geolocation not supported.");
            }
        }

        async function submitUpdate() {
            if (!currentPos.lat) return alert("Please set a location first.");

            const status = document.getElementById('statusSelect').value;
            const btn = document.querySelector('button[onclick="submitUpdate()"]');
            const original = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = "Saving...";

            try {
                const res = await fetch('/tracking/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...currentPos, status })
                });
                const data = await res.json();

                if (data.success) {
                    btn.className = "btn btn-success w-100 py-2 fw-bold shadow-sm";
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Updated!';
                    setTimeout(() => location.href = '/dashboard', 1000);
                } else {
                    alert("Error: " + data.message);
                    btn.disabled = false;
                    btn.innerHTML = original;
                }
            } catch (e) {
                console.error(e);
                alert("Network Error");
                btn.disabled = false;
                btn.innerHTML = original;
            }
        }

        // Init
        locateMe();

    </script>
</body>

</html>